# visual_grasping - 机械臂视觉抓取功能包

## 功能说明

本功能包实现机械臂的自动视觉抓取功能：
- 使用YOLO模型检测桌面上的纸盒
- 使用标定的单应性矩阵将图像坐标转换为机械臂坐标
- 自动执行抓取流程（移动到物体上方 → 下降 → 抓取 → 抬起 → 放开）

## 功能特点

- **智能检测触发**：连续多帧检测 + 位置稳定判断，避免误触发
- **安全抓取**：使用逆运动学，分段移动，碰撞保护
- **自动循环**：抓取完成后自动回到初始位置，继续检测

## 使用方法

### 1. 编译功能包

```bash
cd ~/catkin_ws
catkin_make
source devel/setup.bash
```

### 2. 运行抓取系统

**方法1：使用launch文件**
```bash
roslaunch visual_grasping grasp.launch
```

**方法2：直接运行脚本**
```bash
rosrun visual_grasping grasp.py
```

### 3. 操作说明

1. **启动系统**：
   - 系统会自动初始化机械臂到固定位置
   - 开始检测桌面上的纸盒

2. **检测流程**：
   - 系统持续检测纸盒
   - 当检测到物体且满足条件时（连续5帧检测 + 5秒内位置稳定），自动开始抓取

3. **抓取流程**：
   - 移动到物体上方（预抓取位置）
   - 打开爪子
   - 下降到抓取位置
   - 关闭爪子（抓取）
   - 抬起物体
   - 放开物体
   - 回到初始位置
   - 继续下一次检测

4. **退出**：
   - 按 `q` 键退出程序

## 参数配置

可以通过launch文件或ROS参数设置以下参数：

### 基本参数
- `model`: YOLO模型路径
- `camera_topic`: 摄像头图像话题
- `calibration_path`: 标定结果路径
- `table_height`: 桌面高度（米）
- `object_height`: 物体高度（米）
- `conf_threshold`: YOLO检测置信度阈值

### 检测参数
- `stable_time`: 位置稳定时间（秒），默认5.0
- `position_threshold`: 位置稳定阈值（像素），默认10.0
- `min_detections`: 最小连续检测帧数，默认5

### 抓取参数
- `pre_grasp_offset`: 预抓取位置高度偏移（米），默认0.15
- `lift_offset`: 抬起高度偏移（米），默认0.15
- `move_speed`: 移动速度，默认0.3
- `descent_speed`: 下降速度，默认0.1

## 检测条件

系统只有在满足以下条件时才会开始抓取：

1. **连续检测**：连续5帧都检测到物体
2. **位置稳定**：最近5秒内，所有检测点的位置变化 < 10像素

这样可以避免在放置物体过程中误触发抓取。

## 抓取流程

1. **移动到预抓取位置**：物体上方15cm
2. **打开爪子**
3. **下降到抓取位置**：桌面高度 + 物体高度/2
4. **关闭爪子**（抓取）
5. **抬起**：抓取位置 + 15cm
6. **放开物体**
7. **回到初始位置**：准备下一次抓取

## 依赖

- ROS (Noetic)
- Python 3
- OpenCV (cv2)
- NumPy
- Ultralytics (YOLOv8)
- intera_interface (Sawyer机械臂接口)
- cv_bridge
- Position_Calibration（标定功能包）

## 文件结构

```
visual_grasping/
├── scripts/
│   └── grasp.py              # 主抓取脚本
├── config/
│   └── grasp_params.yaml      # 参数配置文件
├── launch/
│   └── grasp.launch          # 启动文件
├── CMakeLists.txt
├── package.xml
└── README.md
```

## 注意事项

1. **标定结果**：使用前需要先运行 `Position_Calibration` 功能包完成标定
2. **物体放置**：将物体放置在桌面上，系统会自动检测并抓取
3. **安全距离**：确保机械臂工作范围内没有障碍物
4. **光照条件**：确保良好的光照条件，便于YOLO检测
5. **物体位置**：物体应放置在摄像头视野范围内

## 故障排除

- **检测不到物体**：检查光照条件、YOLO模型路径、置信度阈值
- **逆运动学无解**：目标位置可能超出机械臂工作范围，调整物体位置
- **抓取失败**：检查爪子是否正常工作，物体是否在抓取范围内

