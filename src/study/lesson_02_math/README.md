# 第2课：数学基础 - 理解卡尔曼滤波需要的数学

## 🎓 学习目标
掌握卡尔曼滤波需要的核心数学概念

## 📖 核心内容

### 1. 高斯分布（正态分布）

**为什么重要？** 卡尔曼滤波假设噪声是高斯分布的

#### 一维高斯分布
```
f(x) = (1/√(2πσ²)) * exp(-(x-μ)²/(2σ²))
```

- **μ (mu)**：均值（中心位置）
- **σ (sigma)**：标准差（分散程度）
- **σ²**：方差

**直观理解**：
- 大部分值在均值附近
- 离均值越远，概率越小
- 形状像钟形曲线

#### 多维高斯分布
- 有多个变量（如位置x和速度v）
- 用**协方差矩阵**描述变量之间的关系

### 2. 协方差矩阵

**作用**：描述多个变量之间的相关性和不确定性

#### 为什么需要协方差矩阵？

**一维情况**（只有一个变量）：
- 用**方差（σ²）**描述不确定性
- 例如：位置的不确定性 = 2米²

**多维情况**（多个变量）：
- 不仅要知道每个变量的不确定性
- 还要知道变量之间的**相关性**
- 所以需要**协方差矩阵**

#### 2x2协方差矩阵详解

假设状态是 [位置, 速度]：
```
P = [σx²   σxv  ]
    [σxv   σv²  ]
```

**对角线元素**（方差）：
- `P[0][0] = σx²`：位置的不确定性
- `P[1][1] = σv²`：速度的不确定性

**非对角线元素**（协方差）：
- `P[0][1] = P[1][0] = σxv`：位置和速度的相关性

#### 直观理解

**情况1：位置和速度正相关**
```
P = [4   2]  位置不确定性大（4），速度不确定性小（1）
    [2   1]  协方差为正（2），表示位置大时速度也大
```
含义：如果位置估计不准，速度估计也会受影响

**情况2：位置和速度不相关**
```
P = [4   0]  位置不确定性大（4），速度不确定性小（1）
    [0   1]  协方差为0，表示位置和速度独立
```
含义：位置估计不准，不影响速度估计

**情况3：位置和速度负相关**
```
P = [4  -2]  位置不确定性大（4），速度不确定性小（1）
    [-2  1]  协方差为负（-2），表示位置大时速度小
```

#### 实际例子

**场景**：估计小车的位置和速度

**初始状态**（我们不确定）：
```
位置 = 10米 ± 2米  （不确定性大）
速度 = 2米/秒 ± 0.5米/秒  （不确定性小）
```

**协方差矩阵**：
```
P = [4    1]  位置方差=4（2²），速度方差=0.25（0.5²）
    [1  0.25]  协方差=1（位置和速度相关）
```

**含义**：
- 位置不确定：±2米
- 速度不确定：±0.5米/秒
- 两者相关：位置估计不准时，速度估计也会受影响

#### 在卡尔曼滤波中的作用

1. **预测阶段**：不确定性增加，协方差矩阵变大
2. **更新阶段**：融合测量后，不确定性减少，协方差矩阵变小
3. **卡尔曼增益计算**：需要协方差矩阵来决定相信预测还是测量

✅ **练习3的答案**：为什么需要协方差矩阵？
- **单变量**：用方差就够了
- **多变量**：需要描述变量之间的相关性
- **卡尔曼滤波**：需要协方差矩阵来计算最优估计

### 3. 矩阵运算基础

#### 矩阵乘法
```
C = A * B
```
- A的列数 = B的行数
- 结果C的行数 = A的行数，列数 = B的列数

#### 矩阵转置
```
A^T：行变列，列变行
```

#### 矩阵求逆
```
A^(-1)：使得 A * A^(-1) = I（单位矩阵）
```

### 4. 状态向量

**状态向量**：包含所有我们想估计的变量

**例子 - 一维运动**：
```
x = [位置]
    [速度]
```

**例子 - IMU姿态**：
```
x = [roll]   (横滚角)
    [pitch]  (俯仰角)
    [yaw]    (偏航角)
```

### 5. 状态转移矩阵（F）

**作用**：描述状态如何随时间变化

**例子 - 匀速运动**：
```
位置_new = 位置_old + 速度 * dt
速度_new = 速度_old

用矩阵表示：
[位置_new]   [1  dt] [位置_old]
[速度_new] = [0  1 ] [速度_old]

F = [1  dt]
    [0  1 ]
```

### 6. 观测矩阵（H）

**作用**：描述如何从状态得到观测值（传感器能看到什么）

#### 详细理解

**问题**：传感器通常不能直接测量所有状态变量

**场景**：GPS只能测量位置，不能直接测量速度

**状态向量**：
```
x = [位置]
    [速度]
```

**观测值**（传感器能测量的）：
```
z = [位置测量值]
```

**关系**：
```
观测值 = 观测矩阵 × 状态向量
z = H × x
```

#### 推导过程

我们只能测量位置，所以：
```
位置测量值 = 1 × 位置 + 0 × 速度
```

用矩阵表示：
```
[位置测量值] = [1  0] [位置]
                    [速度]
```

**观测矩阵 H**：
```
H = [1  0]
```

**理解每个元素**：
- `H[0][0] = 1`：位置对位置测量的影响（直接测量）
- `H[0][1] = 0`：速度对位置测量的影响（速度不能直接测量）

#### 实际例子

假设：
- 真实状态：位置 = 10米，速度 = 2米/秒
- 观测矩阵：H = [1  0]

计算观测值：
```
[位置测量值] = [1  0] [10] = [1×10 + 0×2] = [10]
                      [2 ]   [            ]   [  ]
```

结果：观测值 = 10米（只看到位置，看不到速度）

#### 如果还能测量速度呢？

如果传感器能同时测量位置和速度：
```
H = [1  0]   ← 位置测量
    [0  1]   ← 速度测量
```

✅ **练习2的答案**：如果只能测量位置，观测矩阵H是：
```
H = [1  0]
```
因为只有第一行，表示只测量第一个状态变量（位置）。

### 7. 噪声协方差

- **Q**：过程噪声（模型不完美）
- **R**：测量噪声（传感器误差）

**理解**：
- Q大：模型不可靠，更相信测量
- R大：测量不可靠，更相信预测

## 🔗 三个核心概念的关联

让我们用一个完整的例子把这三个概念串起来：

**场景**：用GPS和速度计估计小车的位置和速度

### 1. 状态向量 x
```
x = [位置]
    [速度]
```

### 2. 状态转移矩阵 F（预测）
```
F = [1  dt]  根据物理规律预测下一个状态
    [0  1 ]
```
作用：`x_new = F × x_old`

### 3. 观测矩阵 H（测量）
```
H = [1  0]  只能测量位置，不能直接测速度
```
作用：`z = H × x`（从状态得到观测值）

### 4. 协方差矩阵 P（不确定性）
```
P = [σx²  σxv]  描述位置和速度的不确定性及相关性
    [σxv  σv²]
```

### 完整流程
1. **预测**：用F矩阵预测新状态，P矩阵描述预测的不确定性
2. **测量**：用H矩阵从状态得到观测值
3. **更新**：融合预测和测量，用P矩阵计算最优估计

## 💻 代码中的表示

在C++中，我们会用：
- **Eigen库**：处理矩阵运算（ROS常用）
- **std::vector**：存储数据
- **矩阵类**：表示状态、协方差等

## 📝 练习思考（现在你应该能回答了！）

### 练习1：状态转移矩阵
**问题**：如果状态是[位置, 速度]，状态转移矩阵应该是什么？

**提示**：
- 新位置 = 旧位置 + 速度 × dt
- 新速度 = 旧速度

**答案**：
```
F = [1  dt]
    [0  1 ]
```

### 练习2：观测矩阵
**问题**：如果只能测量位置，观测矩阵H是什么？

**提示**：
- 状态是 [位置, 速度]
- 只能测量位置（第一个变量）

**答案**：
```
H = [1  0]
```
第一行表示测量第一个状态变量（位置），第二列是0因为不能测量速度。

### 练习3：协方差矩阵
**问题**：为什么需要协方差矩阵？

**提示**：
- 单变量用方差，多变量需要什么？
- 变量之间可能有相关性

**答案**：
- 描述多个变量的不确定性
- 描述变量之间的相关性
- 卡尔曼滤波计算需要它

## 🎯 下一课预告
第3课：一维卡尔曼滤波 - 最简单的例子，用代码实现

