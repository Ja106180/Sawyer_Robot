# ESP-01S 与 STM32F103C8T6 接线说明

## 接线表

| ESP-01S 引脚 | STM32F103C8T6 引脚 | 说明 |
|-------------|-------------------|------|
| **VCC** | **3.3V** | 电源正极（⚠️ 必须是 3.3V，不能接 5V） |
| **GND** | **GND** | 电源负极（共地） |
| **TX** | **PA10** | ESP-01S 发送 → STM32 接收（USART1_RX） |
| **RX** | **PA9** | ESP-01S 接收 ← STM32 发送（USART1_TX） |
| **CH_PD/EN** | **3.3V** | 使能引脚（必须接高电平，模块才能工作） |
| **RST** | **3.3V** 或 **悬空** | 复位引脚（接高电平或悬空，不接低电平） |
| **IO0** | **悬空** | GPIO0（悬空即可，接低电平会进入下载模式） |
| **IO2** | **悬空** | GPIO2（悬空即可，内部有上拉） |

## 详细说明

### 1. 电源连接（⚠️ 重要）
- **VCC → 3.3V**：ESP-01S 必须使用 3.3V 供电，不能接 5V，否则会烧坏模块
- **GND → GND**：必须共地，否则无法通信
- **电流要求**：ESP-01S 工作电流约 80-170mA，峰值可达 300mA，确保 3.3V 电源能提供足够电流
  - 如果 STM32 的 3.3V 输出电流不够，建议使用外部 3.3V 稳压模块（如 AMS1117-3.3）

### 2. 串口连接（交叉连接）
- **STM32 PA9 (TX) → ESP-01S RX**：STM32 发送数据到 ESP-01S
- **STM32 PA10 (RX) ← ESP-01S TX**：STM32 接收 ESP-01S 的数据
- **波特率**：115200（代码中已配置）

### 3. 控制引脚
- **CH_PD/EN**：使能引脚，**必须接 3.3V**（或通过 10kΩ 上拉电阻接 3.3V）
  - 如果接低电平，模块会进入掉电模式，无法工作
  - **这是必须接的引脚，不接模块不会工作**
- **RST**：复位引脚
  - 可以接 3.3V（或通过 10kΩ 上拉电阻）
  - 也可以悬空（内部有上拉）
  - **不要接低电平**，否则模块会一直复位
- **IO0**：GPIO0，**悬空即可**（不接任何东西）
  - 如果接低电平，模块会进入下载模式（用于烧录固件）
  - 正常运行时必须悬空或接高电平
- **IO2**：GPIO2，**悬空即可**（不接任何东西）
  - 内部有上拉电阻，悬空时默认为高电平
  - 作为透传模块使用时不需要连接

## 接线示意图

```
ESP-01S                    STM32F103C8T6
┌─────────┐                ┌──────────────┐
│  VCC    ├───────────────→│  3.3V       │
│  GND    ├───────────────→│  GND        │
│  TX     ├───────────────→│  PA10 (RX)  │
│  RX     ├←───────────────│  PA9 (TX)   │
│  CH_PD  ├───────────────→│  3.3V       │ (必须接)
│  RST    ├───────────────→│  3.3V       │ (可选，也可悬空)
│  IO0    │  悬空 (不接)    │             │
│  IO2    │  悬空 (不接)    │             │
└─────────┘                └──────────────┘
```

## 注意事项

1. **电源电压**：ESP-01S 绝对不能接 5V，必须 3.3V
2. **电源电流**：确保 3.3V 电源能提供至少 300mA 电流
3. **共地**：STM32 和 ESP-01S 必须共地
4. **CH_PD/EN 必须接 3.3V**：这是使能引脚，不接或接低会导致模块不工作
5. **IO0 和 IO2 悬空**：这两个引脚不需要连接，悬空即可
   - IO0 如果接低电平会进入下载模式
   - IO2 内部有上拉，悬空即可
6. **首次配置**：如果需要用 AT 命令配置 ESP-01S，需要：
   - 使用 USB 转串口模块直接连接 ESP-01S
   - 或者通过 STM32 转发（需要额外代码支持）

## 首次配置 ESP-01S（可选）

如果 ESP-01S 还没有配置过 WiFi 和 TCP 连接，需要先用 USB 转串口模块配置：

### 使用 USB 转串口模块连接
```
ESP-01S          USB转串口模块
VCC  →  3.3V
GND  →  GND
TX   →  RX
RX   →  TX
CH_PD → 3.3V
RST  → 3.3V（或悬空）
```

### AT 命令配置步骤
1. 打开串口调试工具（如 `minicom`、`screen`、`putty`）
2. 波特率设为 115200
3. 发送以下命令：

```bash
AT                          # 测试连接
AT+RST                      # 重启模块
AT+CWMODE=1                 # 设置为 STA 模式
AT+CWJAP="你的WiFi名称","WiFi密码"    # 连接 WiFi
AT+CIPMODE=1                # 设置为透传模式
AT+CIPSTART="TCP","192.168.31.64",11411    # 连接到 PC
AT+CIPSEND                  # 进入透传模式
```

配置完成后，ESP-01S 会自动保存配置，下次上电会自动连接。

## 验证连接

配置完成后，运行 ROS launch 文件：
```bash
cd ~/catkin_ws
source devel/setup.bash
roslaunch yolo_car yolo_car.launch
```

如果连接成功，你应该能看到：
- `rosserial_tcp` 显示 "Client connected"
- STM32 开始接收 ROS 消息

## 故障排查

### ESP-01S 不工作
- 检查 VCC 是否为 3.3V（不是 5V）
- 检查 CH_PD 是否接 3.3V
- 检查 GND 是否共地
- 检查电源电流是否足够

### 无法通信
- 检查 TX/RX 是否交叉连接（STM32 TX → ESP RX，STM32 RX ← ESP TX）
- 检查波特率是否为 115200
- 检查 WiFi 是否已连接
- 检查 PC IP 地址是否正确（192.168.31.64）

### 连接不稳定
- 检查电源是否稳定（建议使用外部 3.3V 稳压模块）
- 检查 GND 连接是否良好
- 检查 WiFi 信号强度

